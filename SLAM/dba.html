<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORB-SLAM2 多线程模拟</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 更换为unpkg的Three.js源 -->
    <script src="https://unpkg.com/three@0.134.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.134.0/examples/js/controls/OrbitControls.js"></script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .thread-status {
                @apply px-3 py-1 rounded-full text-sm font-medium;
            }
            .status-running {
                @apply bg-green-100 text-green-800;
            }
            .status-stopped {
                @apply bg-red-100 text-red-800;
            }
            .status-paused {
                @apply bg-yellow-100 text-yellow-800;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ORB-SLAM2 多线程模拟</h1>
            <p class="text-gray-600">使用 Three.js 实现的可视化系统</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- 控制面板 -->
            <div class="lg:col-span-1 bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-sliders mr-2 text-blue-500"></i>控制面板
                </h2>
                
                <div class="space-y-6">
                    <!-- 线程控制 -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3">线程控制</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span>Tracking 线程</span>
                                <button id="start-tracking" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
                                    启动
                                </button>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>LocalMapping 线程</span>
                                <button id="start-localmapping" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
                                    启动
                                </button>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>Viewer 线程</span>
                                <button id="start-viewer" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
                                    启动
                                </button>
                            </div>
                            <button id="reset-all" class="w-full mt-2 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">
                                重置所有
                            </button>
                        </div>
                    </div>

                    <!-- 线程状态 -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3">线程状态</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span>Tracking:</span>
                                <span id="tracking-status" class="thread-status status-stopped">未运行</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>LocalMapping:</span>
                                <span id="localmapping-status" class="thread-status status-stopped">未运行</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>Viewer:</span>
                                <span id="viewer-status" class="thread-status status-stopped">未运行</span>
                            </div>
                        </div>
                    </div>

                    <!-- 系统信息 -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3">系统信息</h3>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div>
                                <span class="block">关键帧数:</span>
                                <span id="keyframe-count" class="font-medium">0</span>
                            </div>
                            <div>
                                <span class="block">地图点数:</span>
                                <span id="mappoint-count" class="font-medium">0</span>
                            </div>
                            <div>
                                <span class="block">跟踪状态:</span>
                                <span id="tracking-state" class="font-medium">未初始化</span>
                            </div>
                        </div>
                    </div>

                    <!-- 可视化控制 -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3">可视化控制</h3>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="show-points" checked class="mr-2">
                                <span>显示地图点</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="show-keyframes" checked class="mr-2">
                                <span>显示关键帧</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="show-camera" checked class="mr-2">
                                <span>显示当前相机</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="follow-camera" class="mr-2">
                                <span>跟随相机视角</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 可视化区域 -->
            <div class="lg:col-span-3 space-y-6">
                <!-- 3D 视图 -->
                <div class="bg-white rounded-lg shadow-md p-4 h-[600px]">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="fa fa-cube mr-2 text-blue-500"></i>3D 地图视图
                        </h2>
                    </div>
                    <div id="viewer-container" class="w-full h-[550px] bg-gray-900 rounded"></div>
                </div>

                <!-- 当前帧视图 -->
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h2 class="text-xl font-semibold mb-2 flex items-center">
                        <i class="fa fa-camera mr-2 text-blue-500"></i>当前帧与特征点
                    </h2>
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <canvas id="current-frame" class="w-full bg-gray-200 rounded" height="240"></canvas>
                        </div>
                        <div class="flex-1">
                            <canvas id="feature-view" class="w-full bg-gray-200 rounded" height="240"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 多源加载函数 - 尝试多个CDN直到成功
        function loadScript(srcs, callback, errorCallback) {
            if (srcs.length === 0) {
                errorCallback();
                return;
            }
            
            const script = document.createElement('script');
            script.src = srcs[0];
            script.onload = callback;
            script.onerror = () => {
                console.log(`加载失败: ${srcs[0]}, 尝试下一个源`);
                loadScript(srcs.slice(1), callback, errorCallback);
            };
            document.head.appendChild(script);
        }

        // 加载Three.js和OrbitControls的多个备选源
        function loadThreeJS() {
            // Three.js主库的备选源
            const threeSources = [
                'https://unpkg.com/three@0.134.0/build/three.min.js',
                'https://cdn.jsdelivr.net/npm/three@0.134.0/build/three.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js'
            ];
            
            // 先加载Three.js主库
            loadScript(threeSources, () => {
                console.log('Three.js主库加载成功');
                
                // OrbitControls的备选源
                const orbitSources = [
                    'https://unpkg.com/three@0.134.0/examples/js/controls/OrbitControls.js',
                    'https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/controls/OrbitControls.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/controls/OrbitControls.min.js'
                ];
                
                // 再加载OrbitControls
                loadScript(orbitSources, () => {
                    console.log('OrbitControls加载成功');
                    initApp();
                }, () => {
                    console.error('所有OrbitControls源都加载失败');
                    alert('无法加载3D控制器组件，请检查网络连接');
                    // 仍然尝试初始化应用，使用降级方案
                    initApp();
                });
            }, () => {
                console.error('所有Three.js源都加载失败');
                alert('无法加载3D渲染库，请检查网络连接');
            });
        }

        // 页面加载完成后开始加载Three.js
        window.addEventListener('load', loadThreeJS);

        // 全局状态和数据
        const appState = {
            trackingRunning: false,
            localMappingRunning: false,
            viewerRunning: false,
            keyframes: [],
            mapPoints: [],
            currentCameraPose: new THREE.Matrix4(),
            showPoints: true,
            showKeyframes: true,
            showCamera: true,
            followCamera: false,
            trackingState: "未初始化"
        };

        // 初始化Three.js场景
        let scene, camera, renderer, controls;
        let cameraMesh, mapPointsMesh, keyframesMesh = [];
        let lastCameraPosition = new THREE.Vector3();

        function initThreeJS() {
            // 创建场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);
            
            // 添加坐标轴
            const axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);
            
            // 添加网格地面
            const gridHelper = new THREE.GridHelper(20, 20, 0x333333, 0x222222);
            scene.add(gridHelper);

            // 创建相机
            camera = new THREE.PerspectiveCamera(75, document.getElementById('viewer-container').clientWidth / document.getElementById('viewer-container').clientHeight, 0.1, 1000);
            camera.position.z = 10;
            camera.position.y = 5;
            camera.lookAt(new THREE.Vector3(0, 0, 0));

            // 创建渲染器
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(document.getElementById('viewer-container').clientWidth, document.getElementById('viewer-container').clientHeight);
            document.getElementById('viewer-container').appendChild(renderer.domElement);

            // 初始化OrbitControls
            if (typeof THREE !== 'undefined' && typeof THREE.OrbitControls !== 'undefined') {
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
            } else if (typeof OrbitControls !== 'undefined') {
                controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
            } else {
                // 降级方案：没有OrbitControls时使用简单的旋转控制
                console.warn('使用降级方案：无OrbitControls');
                controls = {
                    update: function() {},
                    enableDamping: false
                };
                // 添加简单的鼠标旋转控制
                addBasicRotationControls();
            }

            // 创建相机模型
            const cameraGeometry = new THREE.ConeGeometry(0.3, 1, 16);
            const cameraMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
            cameraMesh = new THREE.Mesh(cameraGeometry, cameraMaterial);
            cameraMesh.rotateX(Math.PI); // 旋转使锥体尖端朝前
            scene.add(cameraMesh);

            // 创建地图点集合
            const mapPointsGeometry = new THREE.BufferGeometry();
            const mapPointsMaterial = new THREE.PointsMaterial({ color: 0x00ffff, size: 0.1 });
            mapPointsMesh = new THREE.Points(mapPointsGeometry, mapPointsMaterial);
            scene.add(mapPointsMesh);

            // 窗口大小调整
            window.addEventListener('resize', onWindowResize);

            // 渲染循环
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
                
                // 如果启用跟随相机模式
                if (appState.followCamera && appState.trackingRunning) {
                    const newPos = new THREE.Vector3().setFromMatrixPosition(cameraMesh.matrixWorld);
                    if (!newPos.equals(lastCameraPosition)) {
                        camera.position.lerp(new THREE.Vector3(newPos.x, newPos.y + 2, newPos.z + 5), 0.1);
                        camera.lookAt(newPos);
                        lastCameraPosition.copy(newPos);
                    }
                }
            }

            animate();
        }

        // 当OrbitControls无法加载时，提供基本的旋转控制
        function addBasicRotationControls() {
            let isRotating = false;
            let lastMouseX = 0;
            let lastMouseY = 0;
            let rotationX = 0;
            let rotationY = 0;

            const container = document.getElementById('viewer-container');
            
            container.addEventListener('mousedown', (e) => {
                isRotating = true;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            });
            
            window.addEventListener('mousemove', (e) => {
                if (!isRotating) return;
                
                const deltaX = e.clientX - lastMouseX;
                const deltaY = e.clientY - lastMouseY;
                
                rotationY += deltaX * 0.005;
                rotationX += deltaY * 0.005;
                
                // 限制X轴旋转
                rotationX = Math.max(-Math.PI/2, Math.min(Math.PI/2, rotationX));
                
                camera.position.x = 10 * Math.sin(rotationY) * Math.cos(rotationX);
                camera.position.y = 10 * Math.sin(rotationX);
                camera.position.z = 10 * Math.cos(rotationY) * Math.cos(rotationX);
                camera.lookAt(new THREE.Vector3(0, 0, 0));
                
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            });
            
            window.addEventListener('mouseup', () => {
                isRotating = false;
            });
            
            container.addEventListener('mouseleave', () => {
                isRotating = false;
            });
        }

        // 窗口大小调整处理
        function onWindowResize() {
            const container = document.getElementById('viewer-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // 更新3D场景
        function updateScene() {
            // 更新相机位置
            cameraMesh.matrixAutoUpdate = false;
            cameraMesh.matrix.copy(appState.currentCameraPose);
            
            // 更新地图点
            if (appState.mapPoints.length > 0) {
                const positions = new Float32Array(appState.mapPoints.length * 3);
                for (let i = 0; i < appState.mapPoints.length; i++) {
                    positions[i * 3] = appState.mapPoints[i].x;
                    positions[i * 3 + 1] = appState.mapPoints[i].y;
                    positions[i * 3 + 2] = appState.mapPoints[i].z;
                }
                mapPointsMesh.geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            }
            
            // 更新关键帧
            keyframesMesh.forEach(mesh => scene.remove(mesh));
            keyframesMesh = [];
            
            if (appState.showKeyframes) {
                const keyframeMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true });
                appState.keyframes.forEach(kf => {
                    const kfGeometry = new THREE.ConeGeometry(0.2, 0.6, 12);
                    const kfMesh = new THREE.Mesh(kfGeometry, keyframeMaterial);
                    kfMesh.rotateX(Math.PI);
                    kfMesh.matrixAutoUpdate = false;
                    kfMesh.matrix.copy(kf.pose);
                    scene.add(kfMesh);
                    keyframesMesh.push(kfMesh);
                });
            }
            
            // 显示/隐藏控制
            mapPointsMesh.visible = appState.showPoints;
            cameraMesh.visible = appState.showCamera;
            
            // 更新UI统计
            document.getElementById('keyframe-count').textContent = appState.keyframes.length;
            document.getElementById('mappoint-count').textContent = appState.mapPoints.length;
            document.getElementById('tracking-state').textContent = appState.trackingState;
        }

        // 初始化画布
        function initCanvases() {
            // 当前帧画布
            const frameCanvas = document.getElementById('current-frame');
            const frameCtx = frameCanvas.getContext('2d');
            frameCanvas.width = frameCanvas.clientWidth;
            frameCanvas.height = frameCanvas.clientHeight;
            
            // 特征点画布
            const featureCanvas = document.getElementById('feature-view');
            const featureCtx = featureCanvas.getContext('2d');
            featureCanvas.width = featureCanvas.clientWidth;
            featureCanvas.height = featureCanvas.clientHeight;
            
            // 绘制初始内容
            frameCtx.fillStyle = '#f0f0f0';
            frameCtx.fillRect(0, 0, frameCanvas.width, frameCanvas.height);
            frameCtx.fillStyle = '#333';
            frameCtx.textAlign = 'center';
            frameCtx.fillText('等待 Tracking 线程启动...', frameCanvas.width / 2, frameCanvas.height / 2);
            
            featureCtx.fillStyle = '#f0f0f0';
            featureCtx.fillRect(0, 0, featureCanvas.width, featureCanvas.height);
            featureCtx.fillStyle = '#333';
            featureCtx.textAlign = 'center';
            featureCtx.fillText('等待特征点数据...', featureCanvas.width / 2, featureCanvas.height / 2);
            
            return { frameCanvas, frameCtx, featureCanvas, featureCtx };
        }

        // 更新画布内容
        function updateCanvases(canvases, frameData) {
            const { frameCanvas, frameCtx, featureCanvas, featureCtx } = canvases;
            
            // 清除画布
            frameCtx.fillStyle = '#f0f0f0';
            frameCtx.fillRect(0, 0, frameCanvas.width, frameCanvas.height);
            
            featureCtx.fillStyle = '#f0f0f0';
            featureCtx.fillRect(0, 0, featureCanvas.width, featureCanvas.height);
            
            // 绘制模拟的当前帧
            frameCtx.fillStyle = '#ddd';
            frameCtx.fillRect(10, 10, frameCanvas.width - 20, frameCanvas.height - 20);
            
            // 绘制帧信息
            frameCtx.fillStyle = '#333';
            frameCtx.textAlign = 'left';
            frameCtx.fillText(`帧 ID: ${frameData.frameId}`, 20, 30);
            frameCtx.fillText(`时间戳: ${frameData.timestamp.toFixed(2)}`, 20, 50);
            frameCtx.fillText(`特征点数: ${frameData.features.length}`, 20, 70);
            
            // 绘制模拟的特征点
            featureCtx.fillStyle = '#ddd';
            featureCtx.fillRect(10, 10, featureCanvas.width - 20, featureCanvas.height - 20);
            
            // 绘制特征点
            frameData.features.forEach(feature => {
                // 在当前帧上绘制
                frameCtx.beginPath();
                frameCtx.arc(
                    10 + feature.x * (frameCanvas.width - 20), 
                    10 + feature.y * (frameCanvas.height - 20), 
                    2, 0, 2 * Math.PI
                );
                frameCtx.fillStyle = feature.inlier ? '#00cc00' : '#cc0000';
                frameCtx.fill();
                
                // 在特征点视图上绘制
                featureCtx.beginPath();
                featureCtx.arc(
                    10 + feature.x * (featureCanvas.width - 20), 
                    10 + feature.y * (featureCanvas.height - 20), 
                    2, 0, 2 * Math.PI
                );
                featureCtx.fillStyle = feature.inlier ? '#00cc00' : '#cc0000';
                featureCtx.fill();
            });
        }

        // Tracking 线程 Worker
        const trackingWorker = new Worker(URL.createObjectURL(new Blob([`
            let running = false;
            let frameId = 0;
            let state = "未初始化";
            let lastPose = { x: 0, y: 0, z: 0, rx: 0, ry: 0, rz: 0 };
            
            function generateRandomFeatures(count) {
                const features = [];
                for (let i = 0; i < count; i++) {
                    features.push({
                        x: Math.random(),
                        y: Math.random(),
                        inlier: Math.random() > 0.2
                    });
                }
                return features;
            }
            
            function updatePose() {
                const t = frameId * 0.1;
                lastPose.x = Math.cos(t) * 5;
                lastPose.z = Math.sin(t) * 5;
                lastPose.y = 1 + Math.sin(t * 0.5) * 0.5;
                
                lastPose.rx = -Math.PI/2 + Math.sin(t * 0.5) * 0.1;
                lastPose.ry = t + Math.PI/2;
                lastPose.rz = 0;
                
                if (Math.random() < 0.02) {
                    const states = ["OK", "OK", "OK", "OK", "OK", "LOST"];
                    state = states[Math.floor(Math.random() * states.length)];
                } else if (state === "未初始化" && frameId > 10) {
                    state = "OK";
                }
                
                return lastPose;
            }
            
            self.onmessage = function(e) {
                if (e.data.command === "start") {
                    running = true;
                    frameId = 0;
                    state = "未初始化";
                    self.postMessage({ type: "status", status: "running" });
                    
                    function processFrame() {
                        if (!running) return;
                        
                        frameId++;
                        const timestamp = performance.now() / 1000;
                        const features = generateRandomFeatures(100 + Math.floor(Math.random() * 50));
                        const pose = updatePose();
                        
                        const newKeyframe = Math.random() < 0.2;
                        
                        self.postMessage({
                            type: "frame",
                            frameId,
                            timestamp,
                            features,
                            pose,
                            state,
                            newKeyframe
                        });
                        
                        setTimeout(processFrame, 100);
                    }
                    
                    processFrame();
                } else if (e.data.command === "stop") {
                    running = false;
                    self.postMessage({ type: "status", status: "stopped" });
                }
            };
        `], { type: 'application/javascript' })));

        // LocalMapping 线程 Worker
        const localMappingWorker = new Worker(URL.createObjectURL(new Blob([`
            let running = false;
            let keyframes = [];
            let mapPoints = [];
            
            function processKeyframe(keyframe) {
                const newPoints = [];
                const pointCount = 10 + Math.floor(Math.random() * 20);
                
                for (let i = 0; i < pointCount; i++) {
                    const offsetX = (Math.random() - 0.5) * 2;
                    const offsetY = (Math.random() - 0.5) * 2;
                    const offsetZ = -1 * (1 + Math.random() * 5);
                    
                    const rx = keyframe.pose.rx;
                    const ry = keyframe.pose.ry;
                    const rz = keyframe.pose.rz;
                    
                    let x = offsetX * Math.cos(ry) * Math.cos(rz) + 
                           offsetY * (Math.sin(rx) * Math.sin(ry) * Math.cos(rz) - Math.cos(rx) * Math.sin(rz)) + 
                           offsetZ * (Math.cos(rx) * Math.sin(ry) * Math.cos(rz) + Math.sin(rx) * Math.sin(rz));
                    
                    let y = offsetX * Math.cos(ry) * Math.sin(rz) + 
                           offsetY * (Math.sin(rx) * Math.sin(ry) * Math.sin(rz) + Math.cos(rx) * Math.cos(rz)) + 
                           offsetZ * (Math.cos(rx) * Math.sin(ry) * Math.sin(rz) - Math.sin(rx) * Math.cos(rz));
                    
                    let z = offsetX * (-Math.sin(ry)) + 
                           offsetY * (Math.sin(rx) * Math.cos(ry)) + 
                           offsetZ * (Math.cos(rx) * Math.cos(ry));
                    
                    x += keyframe.pose.x;
                    y += keyframe.pose.y;
                    z += keyframe.pose.z;
                    
                    newPoints.push({ x, y, z });
                }
                
                return newPoints;
            }
            
            self.onmessage = function(e) {
                if (e.data.command === "start") {
                    running = true;
                    keyframes = [];
                    mapPoints = [];
                    self.postMessage({ type: "status", status: "running" });
                } else if (e.data.command === "stop") {
                    running = false;
                    self.postMessage({ type: "status", status: "stopped" });
                } else if (e.data.command === "addKeyframe" && running) {
                    const keyframe = e.data.keyframe;
                    keyframes.push(keyframe);
                    
                    const newPoints = processKeyframe(keyframe);
                    mapPoints = mapPoints.concat(newPoints);
                    
                    if (mapPoints.length > 1000) {
                        mapPoints = mapPoints.slice(mapPoints.length - 1000);
                    }
                    
                    self.postMessage({
                        type: "mapUpdate",
                        keyframes: keyframes,
                        mapPoints: mapPoints
                    });
                }
            };
        `], { type: 'application/javascript' })));

        // 初始化应用
        function initApp() {
            // 检查Three.js是否可用
            if (typeof THREE === 'undefined') {
                console.error('Three.js未正确加载，无法初始化应用');
                return;
            }
            
            // 初始化Three.js场景
            initThreeJS();
            
            // 初始化画布
            const canvases = initCanvases();
            
            // 线程消息处理
            trackingWorker.onmessage = function(e) {
                if (e.data.type === "status") {
                    appState.trackingRunning = e.data.status === "running";
                    document.getElementById('tracking-status').className = 
                        `thread-status status-${e.data.status === "running" ? "running" : "stopped"}`;
                    document.getElementById('tracking-status').textContent = 
                        e.data.status === "running" ? "运行中" : "已停止";
                } else if (e.data.type === "frame") {
                    appState.trackingState = e.data.state;
                    
                    const pose = e.data.pose;
                    const matrix = new THREE.Matrix4();
                    const rotation = new THREE.Euler(pose.rx, pose.ry, pose.rz, 'XYZ');
                    matrix.makeRotationFromEuler(rotation);
                    matrix.setPosition(pose.x, pose.y, pose.z);
                    appState.currentCameraPose = matrix;
                    
                    updateCanvases(canvases, e.data);
                    
                    if (e.data.newKeyframe && appState.localMappingRunning) {
                        localMappingWorker.postMessage({
                            command: "addKeyframe",
                            keyframe: {
                                id: e.data.frameId,
                                timestamp: e.data.timestamp,
                                pose: e.data.pose,
                                matrix: matrix.toArray()
                            }
                        });
                    }
                    
                    if (appState.viewerRunning) {
                        updateScene();
                    }
                }
            };
            
            localMappingWorker.onmessage = function(e) {
                if (e.data.type === "status") {
                    appState.localMappingRunning = e.data.status === "running";
                    document.getElementById('localmapping-status').className = 
                        `thread-status status-${e.data.status === "running" ? "running" : "stopped"}`;
                    document.getElementById('localmapping-status').textContent = 
                        e.data.status === "running" ? "运行中" : "已停止";
                } else if (e.data.type === "mapUpdate") {
                    appState.keyframes = e.data.keyframes.map(kf => ({
                        id: kf.id,
                        pose: new THREE.Matrix4().fromArray(kf.matrix)
                    }));
                    appState.mapPoints = e.data.mapPoints;
                    
                    if (appState.viewerRunning) {
                        updateScene();
                    }
                }
            };
            
            // 按钮事件监听
            document.getElementById('start-tracking').addEventListener('click', function() {
                if (!appState.trackingRunning) {
                    trackingWorker.postMessage({ command: "start" });
                    this.textContent = "停止";
                    this.className = "bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded";
                } else {
                    trackingWorker.postMessage({ command: "stop" });
                    this.textContent = "启动";
                    this.className = "bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded";
                }
            });
            
            document.getElementById('start-localmapping').addEventListener('click', function() {
                if (!appState.localMappingRunning) {
                    localMappingWorker.postMessage({ command: "start" });
                    this.textContent = "停止";
                    this.className = "bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded";
                } else {
                    localMappingWorker.postMessage({ command: "stop" });
                    this.textContent = "启动";
                    this.className = "bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded";
                }
            });
            
            document.getElementById('start-viewer').addEventListener('click', function() {
                appState.viewerRunning = !appState.viewerRunning;
                if (appState.viewerRunning) {
                    updateScene();
                    this.textContent = "停止";
                    this.className = "bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded";
                    document.getElementById('viewer-status').className = "thread-status status-running";
                    document.getElementById('viewer-status').textContent = "运行中";
                } else {
                    this.textContent = "启动";
                    this.className = "bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded";
                    document.getElementById('viewer-status').className = "thread-status status-stopped";
                    document.getElementById('viewer-status').textContent = "已停止";
                }
            });
            
            document.getElementById('reset-all').addEventListener('click', function() {
                trackingWorker.postMessage({ command: "stop" });
                localMappingWorker.postMessage({ command: "stop" });
                appState.viewerRunning = false;
                
                document.getElementById('start-tracking').textContent = "启动";
                document.getElementById('start-tracking').className = "bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded";
                document.getElementById('start-localmapping').textContent = "启动";
                document.getElementById('start-localmapping').className = "bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded";
                document.getElementById('start-viewer').textContent = "启动";
                document.getElementById('start-viewer').className = "bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded";
                
                document.getElementById('tracking-status').className = "thread-status status-stopped";
                document.getElementById('tracking-status').textContent = "已停止";
                document.getElementById('localmapping-status').className = "thread-status status-stopped";
                document.getElementById('localmapping-status').textContent = "已停止";
                document.getElementById('viewer-status').className = "thread-status status-stopped";
                document.getElementById('viewer-status').textContent = "已停止";
                
                appState.keyframes = [];
                appState.mapPoints = [];
                appState.currentCameraPose = new THREE.Matrix4();
                appState.trackingState = "未初始化";
                
                updateScene();
                updateCanvases(canvases, { frameId: 0, timestamp: 0, features: [] });
            });
            
            // 可视化控制
            document.getElementById('show-points').addEventListener('change', function(e) {
                appState.showPoints = e.target.checked;
                if (appState.viewerRunning) {
                    updateScene();
                }
            });
            
            document.getElementById('show-keyframes').addEventListener('change', function(e) {
                appState.showKeyframes = e.target.checked;
                if (appState.viewerRunning) {
                    updateScene();
                }
            });
            
            document.getElementById('show-camera').addEventListener('change', function(e) {
                appState.showCamera = e.target.checked;
                if (appState.viewerRunning) {
                    updateScene();
                }
            });
            
            document.getElementById('follow-camera').addEventListener('change', function(e) {
                appState.followCamera = e.target.checked;
            });
        }
    </script>
</body>
</html>
    