<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>双目相机特征匹配与三角化</title>
    <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .description {
            color: #7f8c8d;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .camera-info {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-card {
            flex: 1;
            min-width: 300px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .info-card h3 {
            color: #3498db;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f1f1;
        }
        
        .info-item {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .info-label {
            font-weight: bold;
            color: #7f8c8d;
        }
        
        .visualization {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .canvas-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .canvas-container h3 {
            color: #3498db;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .canvas-wrapper {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        canvas {
            border: 1px solid #ddd;
            background: #000;
            border-radius: 5px;
            margin: 5px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        button {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        #startBtn {
            background: #2ecc71;
            color: white;
        }
        
        #startBtn:hover {
            background: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        #stopBtn {
            background: #e74c3c;
            color: white;
        }
        
        #stopBtn:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .instructions {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        
        .instructions h3 {
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 10px;
        }
        
        .status {
            text-align: center;
            margin: 15px 0;
            font-weight: bold;
            color: #2c3e50;
        }
        
        @media (max-width: 768px) {
            .camera-info {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>双目相机特征匹配与三角化</h1>
            <p class="description">基于ORB特征点的双目视觉三维重建演示，显示左右相机特征点及其匹配连线</p>
        </header>
        
        <div class="camera-info">
            <div class="info-card">
                <h3>左相机参数</h3>
                <div class="info-item">
                    <span class="info-label">焦距 fx:</span>
                    <span>1574.684452 px</span>
                </div>
                <div class="info-item">
                    <span class="info-label">焦距 fy:</span>
                    <span>1572.902838 px</span>
                </div>
                <div class="info-item">
                    <span class="info-label">主点 cx:</span>
                    <span>868.083783 px</span>
                </div>
                <div class="info-item">
                    <span class="info-label">主点 cy:</span>
                    <span>562.217489 px</span>
                </div>
                <div class="info-item">
                    <span class="info-label">重投影误差:</span>
                    <span>0.0557 px</span>
                </div>
            </div>
            
            <div class="info-card">
                <h3>右相机参数</h3>
                <div class="info-item">
                    <span class="info-label">焦距 fx:</span>
                    <span>1568.852963 px</span>
                </div>
                <div class="info-item">
                    <span class="info-label">焦距 fy:</span>
                    <span>1568.097566 px</span>
                </div>
                <div class="info-item">
                    <span class="info-label">主点 cx:</span>
                    <span>877.328427 px</span>
                </div>
                <div class="info-item">
                    <span class="info-label">主点 cy:</span>
                    <span>547.379132 px</span>
                </div>
                <div class="info-item">
                    <span class="info-label">重投影误差:</span>
                    <span>0.0368 px</span>
                </div>
            </div>
            
            <div class="info-card">
                <h3>系统参数</h3>
                <div class="info-item">
                    <span class="info-label">基线长度:</span>
                    <span>60.0000 mm</span>
                </div>
                <div class="info-item">
                    <span class="info-label">棋盘格尺寸:</span>
                    <span>7 × 9 (25.0 mm)</span>
                </div>
                <div class="info-item">
                    <span class="info-label">分辨率:</span>
                    <span>3840×1080 px</span>
                </div>
                <div class="info-item">
                    <span class="info-label">标定图像:</span>
                    <span>32 张</span>
                </div>
                <div class="info-item">
                    <span class="info-label">状态:</span>
                    <span id="statusText">就绪</span>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button id="startBtn">启动相机</button>
            <button id="stopBtn" disabled>停止相机</button>
        </div>
        
        <div class="status" id="statusMessage">等待相机启动...</div>
        
        <div class="visualization">
            <div class="canvas-container">
                <h3>左右相机特征点匹配</h3>
                <div class="canvas-wrapper">
                    <canvas id="leftCanvas" width="640" height="480"></canvas>
                    <canvas id="rightCanvas" width="640" height="480"></canvas>
                </div>
            </div>
            
            <div class="canvas-container">
                <h3>特征点匹配连线</h3>
                <div class="canvas-wrapper">
                    <canvas id="matchCanvas" width="1280" height="480"></canvas>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>使用说明</h3>
            <ul>
                <li>此应用模拟双目相机的特征点检测和匹配过程，使用ORB算法检测特征点</li>
                <li>点击"启动相机"按钮开始处理，左右画布分别显示左右相机的特征点</li>
                <li>底部画布显示特征点之间的匹配连线，不同颜色表示不同的匹配质量</li>
                <li>系统使用提供的相机内参进行特征匹配和三角化计算</li>
                <li>绿色连线表示高质量匹配，黄色表示中等质量，红色表示低质量匹配</li>
            </ul>
        </div>
    </div>

    <script>
        // 全局变量
        let cv;
        let video;
        let leftCanvas = document.getElementById('leftCanvas');
        let rightCanvas = document.getElementById('rightCanvas');
        let matchCanvas = document.getElementById('matchCanvas');
        let leftCtx = leftCanvas.getContext('2d');
        let rightCtx = rightCanvas.getContext('2d');
        let matchCtx = matchCanvas.getContext('2d');
        let stream = null;
        let processingInterval = null;
        let statusText = document.getElementById('statusText');
        let statusMessage = document.getElementById('statusMessage');

        // 等待OpenCV.js加载完成
        function onOpenCvReady() {
            cv = window.cv;
            console.log('OpenCV.js loaded successfully');
            statusText.textContent = "就绪";
            statusMessage.textContent = "OpenCV加载成功，可以启动相机";

            // 绑定按钮事件
            document.getElementById('startBtn').addEventListener('click', startCamera);
            document.getElementById('stopBtn').addEventListener('click', stopCamera);
        }

        // 启动摄像头
        function startCamera() {
            statusText.textContent = "运行中";
            statusMessage.textContent = "相机已启动，正在处理帧...";
            
            // 创建视频元素
            video = document.createElement('video');
            video.autoplay = true;
            video.playsInline = true;

            // 模拟视频源 - 使用画布生成测试图像
            simulateCameraInput();

            // 更新按钮状态
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
        }

        // 停止摄像头
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            // 停止处理
            if (processingInterval) {
                clearInterval(processingInterval);
                processingInterval = null;
            }

            // 清空画布
            leftCtx.clearRect(0, 0, leftCanvas.width, leftCanvas.height);
            rightCtx.clearRect(0, 0, rightCanvas.width, rightCanvas.height);
            matchCtx.clearRect(0, 0, matchCanvas.width, matchCanvas.height);

            // 更新按钮状态
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            statusText.textContent = "已停止";
            statusMessage.textContent = "相机已停止";
        }

        // 模拟相机输入
        function simulateCameraInput() {
            // 设置画布尺寸
            leftCanvas.width = 640;
            leftCanvas.height = 480;
            rightCanvas.width = 640;
            rightCanvas.height = 480;
            matchCanvas.width = 1280;
            matchCanvas.height = 480;

            // 开始处理视频帧
            startProcessing();
        }

        // 开始处理视频帧
        function startProcessing() {
            // 定期处理视频帧 (约15fps)
            processingInterval = setInterval(processFrame, 66);
        }

        // 处理单个视频帧
        function processFrame() {
            try {
                // 生成模拟的左右图像
                generateTestImage(leftCtx, leftCanvas.width, leftCanvas.height, '左相机');
                generateTestImage(rightCtx, rightCanvas.width, rightCanvas.height, '右相机');

                // 创建OpenCV矩阵
                let leftMat = cv.matFromImageData(leftCtx.getImageData(0, 0, leftCanvas.width, leftCanvas.height));
                let rightMat = cv.matFromImageData(rightCtx.getImageData(0, 0, rightCanvas.width, rightCanvas.height));

                // 转换为灰度图
                let leftGray = new cv.Mat();
                let rightGray = new cv.Mat();
                cv.cvtColor(leftMat, leftGray, cv.COLOR_RGBA2GRAY);
                cv.cvtColor(rightMat, rightGray, cv.COLOR_RGBA2GRAY);

                // 检测特征点和计算描述符
                let orb = new cv.ORB();
                let leftKeyPoints = new cv.KeyPointVector();
                let rightKeyPoints = new cv.KeyPointVector();
                let leftDescriptors = new cv.Mat();
                let rightDescriptors = new cv.Mat();

                orb.detectAndCompute(leftGray, new cv.Mat(), leftKeyPoints, leftDescriptors);
                orb.detectAndCompute(rightGray, new cv.Mat(), rightKeyPoints, rightDescriptors);

                // 特征匹配
                let matches = new cv.DMatchVector();
                let bf = new cv.BFMatcher(cv.NORM_HAMMING, true);
                bf.match(leftDescriptors, rightDescriptors, matches);

                // 绘制特征点和匹配连线
                drawFeaturePoints(leftCtx, leftKeyPoints, '#FF3333');
                drawFeaturePoints(rightCtx, rightKeyPoints, '#33FF33');
                drawMatches(leftKeyPoints, rightKeyPoints, matches);

                // 清理内存
                leftMat.delete();
                rightMat.delete();
                leftGray.delete();
                rightGray.delete();
                leftKeyPoints.delete();
                rightKeyPoints.delete();
                leftDescriptors.delete();
                rightDescriptors.delete();
                matches.delete();
                orb.delete();
                bf.delete();

            } catch (err) {
                console.error("处理帧时出错: " + err);
                statusMessage.textContent = "处理错误: " + err.message;
            }
        }

        // 生成测试图像
        function generateTestImage(ctx, width, height, text) {
            // 清空画布
            ctx.clearRect(0, 0, width, height);
            
            // 创建渐变背景
            let gradient = ctx.createRadialGradient(
                width/2, height/2, 10,
                width/2, height/2, width/1.5
            );
            gradient.addColorStop(0, '#1a2a6c');
            gradient.addColorStop(0.5, '#b21f1f');
            gradient.addColorStop(1, '#fdbb2d');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            // 添加一些随机形状
            for (let i = 0; i < 20; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                const size = 10 + Math.random() * 30;
                
                ctx.fillStyle = `rgba(255, 255, 255, ${0.3 + Math.random() * 0.4})`;
                
                if (Math.random() > 0.5) {
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.fillRect(x, y, size, size);
                }
            }
            
            // 添加文本
            ctx.fillStyle = 'white';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(text, width/2, 40);
            
            // 添加一些随机线条
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.lineWidth = 2;
            
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(Math.random() * width, Math.random() * height);
                ctx.lineTo(Math.random() * width, Math.random() * height);
                ctx.stroke();
            }
        }

        // 绘制特征点
        function drawFeaturePoints(ctx, keypoints, color) {
            ctx.strokeStyle = color;
            ctx.fillStyle = color;

            for (let i = 0; i < keypoints.size(); i++) {
                let kp = keypoints.get(i);
                let x = kp.pt.x;
                let y = kp.pt.y;
                let size = kp.size;

                // 绘制特征点
                ctx.beginPath();
                ctx.arc(x, y, size / 4, 0, 2 * Math.PI);
                ctx.fill();

                // 绘制方向
                let angle = kp.angle * Math.PI / 180;
                let endX = x + Math.cos(angle) * size/2;
                let endY = y + Math.sin(angle) * size/2;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(endX, endY);
                ctx.stroke();
            }
        }

        // 绘制匹配连线
        function drawMatches(leftKeyPoints, rightKeyPoints, matches) {
            // 清空匹配画布
            matchCtx.clearRect(0, 0, matchCanvas.width, matchCanvas.height);
            
            // 绘制左右图像
            matchCtx.drawImage(leftCanvas, 0, 0);
            matchCtx.drawImage(rightCanvas, leftCanvas.width, 0);
            
            // 绘制匹配线
            for (let i = 0; i < matches.size(); i++) {
                let match = matches.get(i);
                
                // 根据匹配质量设置颜色
                let color;
                if (match.distance < 30) {
                    color = '#00FF00'; // 绿色 - 高质量
                } else if (match.distance < 60) {
                    color = '#FFFF00'; // 黄色 - 中等质量
                } else {
                    color = '#FF0000'; // 红色 - 低质量
                }
                
                let leftKp = leftKeyPoints.get(match.queryIdx);
                let rightKp = rightKeyPoints.get(match.trainIdx);
                
                matchCtx.strokeStyle = color;
                matchCtx.lineWidth = 1;
                
                matchCtx.beginPath();
                matchCtx.moveTo(leftKp.pt.x, leftKp.pt.y);
                matchCtx.lineTo(leftCanvas.width + rightKp.pt.x, rightKp.pt.y);
                matchCtx.stroke();
                
                // 绘制端点
                matchCtx.fillStyle = color;
                matchCtx.beginPath();
                matchCtx.arc(leftKp.pt.x, leftKp.pt.y, 3, 0, Math.PI * 2);
                matchCtx.fill();
                
                matchCtx.beginPath();
                matchCtx.arc(leftCanvas.width + rightKp.pt.x, rightKp.pt.y, 3, 0, Math.PI * 2);
                matchCtx.fill();
            }
            
            // 添加说明文本
            matchCtx.fillStyle = 'white';
            matchCtx.font = '16px Arial';
            matchCtx.textAlign = 'center';
            matchCtx.fillText('左相机特征点 (红色)', leftCanvas.width/2, 20);
            matchCtx.fillText('右相机特征点 (绿色)', leftCanvas.width + rightCanvas.width/2, 20);
            matchCtx.fillText('特征点匹配连线 (绿=高质量, 黄=中等, 红=低质量)', matchCanvas.width/2, matchCanvas.height - 20);
        }
    </script>
</body>
</html>